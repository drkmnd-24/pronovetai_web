{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OD-Forms – PronoveTAI</title>

    <!-- styles -->
    <link rel="shortcut icon" href="{% static 'assets/compiled/svg/favicon.svg' %}">
    <link rel="stylesheet" href="{% static 'assets/extensions/datatables.net-bs5/css/dataTables.bootstrap5.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/compiled/css/table-datatable-jquery.css' %}">
    <link rel="stylesheet" href="{% static 'assets/compiled/css/app.css' %}">
    <link rel="stylesheet" href="{% static 'assets/compiled/css/app-dark.css' %}">
</head>
<body>
<script src="{% static 'assets/static/js/initTheme.js' %}"></script>

<div id="app">
    {% include '_sidebar.html' with active="odform_list" %}
    <div id="main">
        <header class="mb-3">
            <a href="#" class="burger-btn d-block d-xl-none"><i class="bi bi-justify fs-3"></i></a>
        </header>

        <div class="page-heading">
            <div class="page-title">
                <div class="row">
                    <div class="col-12 col-md-6 order-md-1 order-last">
                        <h3>OD-Forms</h3>
                        <p class="text-subtitle text-muted">Interactive Datatable for OD-Forms</p>
                    </div>
                    <div class="col-12 col-md-6 order-md-2 order-first">
                        <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                                <li class="breadcrumb-item active" aria-current="page">OD-Forms</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- ───────────── table & add button ───────────── -->
            <section class="section">
                <div class="card">
                    <div class="card-body">
                        <!-- ADD BUTTON -->
                        <button class="btn btn-primary mb-3"
                                data-bs-toggle="modal"
                                data-bs-target="#exampleModalScrollable">
                            <i class="bi bi-plus-lg me-1"></i> Add OD-Form
                        </button>

                        <div class="table-responsive">
                            <table id="odforms-table" class="table table-striped">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Created&nbsp;On</th>
                                    <th>Call&nbsp;Taken&nbsp;By</th>
                                    <th>Intent</th>
                                    <th>Status</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        {% include '_footer.html' %}
    </div>
</div>

<!-- ───────────── scrollable modal ───────────── -->
<div class="col-md-6 col-12">
    <div class="modal fade" id="exampleModalScrollable" tabindex="-1" role="dialog"
         aria-labelledby="exampleModalScrollableTitle" aria-hidden="true">
        <div class="modal-xl modal-dialog modal-dialog-scrollable" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalScrollableTitle">Create New OD</h5>
                    <button type="button" class="close" data-bs-dismiss="modal"
                            aria-label="Close">
                        <i data-feather="x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="card-content">
                        <div class="card-body">
                            <form id="odformForm" class="form">
                                <div class="row">
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label class="form-label">Date</label>
                                            <input type="date" id="date_today"
                                                   class="form-control mb-3 flatpickr-calendar" name="created">
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label for="first-name-column">Call Taken/Made By</label>
                                            <input type="text" class="form-control" name="call_taken_by" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label for="last-name-column">Type of Call</label>
                                            <select name="type_of_call" class="form-select" required>
                                                <option value="" hidden>Choose...</option>
                                                <option value="inbound">Inbound</option>
                                                <option value="outbound">Outbound</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label for="last-name-column">Source of Call</label>
                                            <select name="source_of_call" id="source_of_call" class="form-select"
                                                    required>
                                                <option hidden value>Choose…</option>
                                                <option value="newspaper">Newspaper</option>
                                                <option value="old_client">Old client</option>
                                                <option value="online_marketing">Online marketing</option>
                                                <option value="referral">Referral</option>
                                                <option value="signage">Signage</option>
                                                <option value="website">Website</option>
                                                <option value="yellow_pages">Yellow Pages</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label for="last-name-column">Type of Caller</label>
                                            <select name="type_of_caller" class="form-select" required>
                                                <option hidden value>Choose…</option>
                                                <option value="broker">Broker</option>
                                                <option value="direct">Direct buyer / lessee</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label for="last-name-column">Intent</label>
                                            <select name="intent" class="form-select" required>
                                                <option hidden value>Choose…</option>
                                                <option value="rent">Lease / Rent</option>
                                                <option value="buy">Purchase</option>
                                                <option value="both">Both</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label class="form-label">Purpose</label>
                                            <select name="purpose" class="form-select" required>
                                                <option hidden value>Choose...</option>
                                                <option value="expanding">Expanding</option>
                                                <option value="relocating">Relocating</option>
                                                <option value="new_office">New Office</option>
                                                <option value="consolidating">Consolidating</option>
                                                <option value="downsizing">Downsizing</option>
                                                <option value="upgrading">Upgrading</option>
                                                <option value="expanding_retaining">Expand &amp; retain</option>
                                                <option value="others">Others</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label class="form-label">Size (min&nbsp;㎡)</label>
                                            <input type="number" class="form-control" name="size_minimum" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label for="last-name-column">Size (max&nbsp;㎡) </label>
                                            <input type="text" class="form-control" name="size_maximum" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label for="last-name-column">Budget (min ₱) </label>
                                            <input name="budget_minimum" type="number" class="form-control" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label class="form-label">Budget (max ₱)</label>
                                            <input name="budget_maximum" type="number" class="form-control" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label for="last-name-column">Preferred Location </label>
                                            <input type="text" class="form-control" name="preferred_location" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group mb-3">
                                            <label id="exampleFormControlTextarea1">Notes</label>
                                            <textarea name="notes" rows="4" class="form-control" for="exampleFormControlTextarea1" required></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <div class="form-group">
                                            <label for="last-name-column">Status</label>
                                            <select name="status" class="form-select" required>
                                                <option hidden value>Choose…</option>
                                                <option value="active">Active</option>
                                                <option value="inactive">Inactive</option>
                                                <option value="done_deal">Done deal</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light-secondary"
                            data-bs-dismiss="modal">
                        <i class="bx bx-x d-block d-sm-none"></i>
                        <span class="d-none d-sm-block">Close</span>
                    </button>
                    <button type="button" id="saveOdFormBtn" class="btn btn-primary ms-1" data-bs-dismiss="modal">
                        <i class="bx bx-check d-block d-sm-none"></i>
                        <span class="d-none d-sm-block">Create OD</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- scripts -->
<script src="{% static 'assets/static/js/components/dark.js' %}"></script>
<script src="{% static 'assets/extensions/perfect-scrollbar/perfect-scrollbar.min.js' %}"></script>
<script src="{% static 'assets/compiled/js/app.js' %}"></script>

<script src="{% static 'assets/extensions/jquery/jquery.min.js' %}"></script>
<script src="{% static 'assets/extensions/datatables.net/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/extensions/datatables.net-bs5/js/dataTables.bootstrap5.min.js' %}"></script>

<script>
    /* ───────── helpers ─────────────────────────── */
    const toast = msg => {
        const el = $(`
   <div class="toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-3" role="alert">
     <div class="d-flex">
       <div class="toast-body">${msg}</div>
       <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
     </div>
   </div>`).appendTo('body');
        new bootstrap.Toast(el[0]).show();
    };

    /* ───────── DataTable ───────────────────────── */
    const $table = $('#odforms-table');
    let dt, editingId = null;           // ← keep id when in “edit” mode
    const token = localStorage.getItem('access');

    $(initTable);

    function initTable() {
        if (!token) return location.href = '/';

        dt = $table.DataTable({
            ajax: {
                url: '/api/odforms/',
                headers: {Authorization: `Bearer ${token}`},
                dataSrc: json => Array.isArray(json) ? json : json.results,
                error: xhr => alert(`Could not load OD-forms (${xhr.status} ${xhr.statusText})`)
            },
            columns: [
                {data: 'id'},
                {data: 'created', render: v => v ? v.slice(0, 10) : '—', className: 'whitespace-nowrap'},
                {data: 'call_taken_by', defaultContent: '—'},
                {data: 'intent', defaultContent: '—'},
                {
                    data: 'status', className: 'text-center',
                    render: s => {
                        const m = {
                            draft: 'secondary', pending: 'warning', active: 'primary',
                            done_deal: 'success', inactive: 'secondary', cancelled: 'danger'
                        };
                        return `<span class="badge bg-${m[s] || 'light'}">${s || '—'}</span>`;
                    }
                },
                { /* Actions column */
                    data: null,
                    orderable: false,
                    searchable: false,
                    className: 'text-center',
                    render: (_, __, row) => `
          <button class="btn btn-sm btn-outline-primary edit-od"   title="Edit"   data-id="${row.id}">
            <i class="bi bi-pencil-square"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger  delete-od" title="Delete" data-id="${row.id}">
            <i class="bi bi-trash"></i>
          </button>`
                }
            ],
            order: [[1, 'desc']],
            pageLength: 25,
            lengthMenu: [25, 50, 100],
            responsive: true
        });
    }

    /* ───────── set / reset form helpers ───────── */
    const $modal = $('#exampleModalScrollable');
    const $form = $('#odformForm')[0];

    function resetForm() {
        $form.reset();
        editingId = null;
    }

    /* ───────── add / edit (open modal) ───────── */
    $table.on('click', '.edit-od', async function () {
        const id = this.dataset.id;
        try {
            const r = await fetch(`/api/odforms/${id}/`, {headers: {Authorization: `Bearer ${token}`}});
            if (!r.ok) throw await r.text();
            const data = await r.json();
            // fill form —— keys must match input[name]
            Object.entries(data).forEach(([k, v]) => {
                const el = $form.elements.namedItem(k);
                if (!el) return;
                if (el.type === 'checkbox') el.checked = !!v;
                else el.value = v ?? '';
            });
            editingId = id;
            new bootstrap.Modal($modal[0]).show();
        } catch (err) {
            alert('Could not load record: ' + err);
        }
    });

    /* ───────── delete ───────── */
    $table.on('click', '.delete-od', function () {
        const id = this.dataset.id;
        if (!confirm('Delete OD-Form #' + id + ' ?')) return;
        fetch(`/api/odforms/${id}/`, {
            method: 'DELETE',
            headers: {Authorization: `Bearer ${token}`}
        })
            .then(r => {
                if (r.ok) {
                    toast('Deleted');
                    dt.ajax.reload(null, false);
                } else r.text().then(t => alert('Error: ' + t));
            });
    });

    /* ───────── save (create OR edit) ───────── */
    $('#saveOdFormBtn').on('click', async e => {
        e.preventDefault();
        if (!$form.checkValidity()) {
            $form.reportValidity();
            return;
        }

        const fd = new FormData($form);
        ['size_minimum', 'size_maximum', 'budget_minimum', 'budget_maximum']
            .forEach(k => {
                if (fd.get(k) === '') fd.delete(k);
            });

        if (!fd.get('created')) fd.set('created', new Date().toISOString());

        const payload = Object.fromEntries(fd);

        const opts = {
            method: editingId ? 'PATCH' : 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(payload)
        };
        const url = editingId ? `/api/odforms/${editingId}/` : '/api/odforms/';

        const r = await fetch(url, opts);
        const txt = await r.text();
        let data;
        try {
            data = JSON.parse(txt);
        } catch {
            data = txt;
        }

        if (r.ok) {
            bootstrap.Modal.getInstance($modal[0]).hide();
            resetForm();
            dt.ajax.reload(null, false);
            toast(editingId ? 'Updated' : 'Created');
        } else {
            alert('Error ' + r.status + ': ' + (data.detail || JSON.stringify(data).slice(0, 300)));
        }
    });

    /* ───────── clear form when opening in “add” mode ───────── */
    $('[data-bs-target="#exampleModalScrollable"]').on('click', resetForm);
</script>

</body>
</html>
